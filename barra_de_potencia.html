<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Barra de Potencia</title>
    <style>
        body {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: sans-serif;
        }

        #newPowerBarContainer {
            width: 50px; /* Ancho de la barra */
            height: 300px; /* Altura total de la barra */
            /* --- NUEVO: Degradado de fondo con líneas --- */
            background: 
                /* Capa 2: Líneas horizontales repetidas */
                repeating-linear-gradient(
                    to top,
                    transparent, transparent 19px, /* 19px de espacio transparente */
                    rgba(0, 0, 0, 0.3) 19px, rgba(0, 0, 0, 0.3) 20px /* 1px de línea oscura */
                ),
                /* Capa 1: Degradado de color de fondo */
                linear-gradient(to top, #e74c3c, #ff8c00, #f1c40f); /* Rojo -> Naranja -> Amarillo */

            border: 2px solid #333;
            border-radius: 25px;
            position: relative;
            overflow: hidden; /* Para que el relleno no se salga */
        }

        #newPowerBarHandle {
            width: 150px; /* Altura original del taco, ahora será el ancho */
            height: 40px; /* Ancho original del taco, ahora será la altura */
            object-fit: contain;
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%) rotate(270deg); /* Centrar horizontal y verticalmente, y luego rotar */
            top: 0%;
            transform-origin: center center; /* Asegurar que la rotación sea desde el centro */
            cursor: grab;
            transition: top 0.1s linear;
        }
    </style>
</head>
<body>
    <div id="newPowerBarContainer">
        <div id="newPowerBarHandle" style="background-image: url('imajenes/taco.png'); background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
    </div>

    <script>
        const newPowerBarContainer = document.getElementById('newPowerBarContainer');
        const newPowerBarHandle = document.getElementById('newPowerBarHandle');
        // const powerDisplay = document.getElementById('powerDisplay'); // Ya no es necesario

        let isDragging = false;
        let powerPercent = 0;
        let dragStartY = 0; // --- NUEVO: Para guardar la posición Y inicial del arrastre

        // --- CORRECCIÓN: El evento ahora se escucha en todo el contenedor de la barra ---
        newPowerBarContainer.addEventListener('pointerdown', (e) => {
            isDragging = true;
            newPowerBarContainer.setPointerCapture(e.pointerId); // Capturar el puntero en el contenedor
            e.preventDefault(); // Prevenir el comportamiento por defecto del navegador

            // --- CORRECCIÓN: Guardar la posición Y inicial y resetear la barra a 0% ---
            dragStartY = e.clientY;
            powerPercent = 0;
            updatePowerBar(0); // Actualizar la UI a 0%
        });

        document.addEventListener('pointermove', (e) => {
            if (!isDragging) return;

            const rect = newPowerBarContainer.getBoundingClientRect();
            const containerHeight = rect.height;

            // Calcular el desplazamiento desde el inicio del arrastre
            const dragDistance = dragStartY - e.clientY; 

            // --- CORRECCIÓN: El 100% de potencia se alcanza al 80% del recorrido ---
            // La potencia se calcula sobre la altura total, pero se limita a 0.8 (80%).
            const newPowerPercent = Math.max(0, Math.min(dragDistance / containerHeight, 0.8));
            
            powerPercent = newPowerPercent;
            updatePowerBar(powerPercent);
        });

        document.addEventListener('pointerup', (e) => {
            if (isDragging) {
                isDragging = false;
                // Liberar la captura del puntero desde el contenedor
                // Es importante hacer esto para que otros elementos de la UI vuelvan a funcionar.
                // Usamos un try-catch por si el puntero ya se liberó por otras razones (ej. salir de la ventana).
                try {
                    // --- CORRECCIÓN: Usar el 'e' del evento para obtener el pointerId ---
                    if (e.pointerId) newPowerBarContainer.releasePointerCapture(e.pointerId);
                } catch (err) {
                    // No hacer nada si hay un error, significa que la captura ya no existía.
                }
                console.log('Potencia final:', powerPercent);

                // --- NUEVO: Animar la barra de vuelta a 0% ---
                // La transición CSS se encargará de la animación visual.
                updatePowerBar(0);
            }
        });

        // --- NUEVO: Función que actualiza la UI de la barra de potencia ---
        function updatePowerBar(percent) {
            // --- CORRECCIÓN: Obtener las dimensiones del contenedor DENTRO de la función ---
            const containerHeight = newPowerBarContainer.offsetHeight;
            const handleHeight = newPowerBarHandle.offsetHeight;
            const extraDragAmount = handleHeight * 1.5;
            const visualMaxY = containerHeight + extraDragAmount;

            // Calcular las posiciones 'top' basadas en el porcentaje de potencia (que va de 0 a 1)
            // Ambas posiciones deben calcularse de la misma manera para que estén sincronizadas.
            // La posición del relleno va de containerHeight (abajo) a 0 (arriba).
            const logicalY = containerHeight * (1 - percent);
            // La posición del taco debe seguir al relleno, pero con un desplazamiento adicional
            // que se reduce a medida que la potencia aumenta, para que la punta siempre coincida.
            const visualY = logicalY + extraDragAmount * (1 - percent);

            newPowerBarHandle.style.top = `${visualY}px`;
            // powerDisplay.textContent = `${Math.round((percent / 0.8) * 100)}%`; // Ya no es necesario
        }


        // Inicializar la barra de potencia a 0
        // --- CORRECCIÓN: Posicionar el relleno en la parte inferior al inicio ---
        const initialContainerHeight = newPowerBarContainer.offsetHeight;
        const initialHandleHeight = newPowerBarHandle.offsetHeight;
        const initialExtraDrag = initialHandleHeight * 1.5; // Usar el mismo multiplicador que en el evento 'pointermove'

        // --- CORRECCIÓN: Posicionar el taco en su punto más bajo posible, que es 0% de potencia.
        // La posición inicial del taco es la del relleno (initialContainerHeight) más el extra.
        newPowerBarHandle.style.top = `${initialContainerHeight + initialExtraDrag}px`;
        // powerDisplay.textContent = '0%'; // Ya no es necesario
    </script>
</body>
</html>