<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlackBall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- SOLUCIÓN: Evita el error 404 de favicon.ico en la consola -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- NUEVO: SDK de PocketBase -->
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-orientation" content="landscape">
    <link rel="apple-touch-icon" href="../imajenes/apple-touch-icon.png">
    <link rel="stylesheet" href="./home-ecensiales/style.css">
    <!-- NUEVO: Estilos para la pantalla de rotación en iOS -->
    <style>
      #rotate-device-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color, #1a1a1a);
        z-index: 10000;
        display: none; /* Oculto por defecto */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: var(--text-color, #ffffff);
        font-family: 'Roboto', sans-serif;
        text-align: center;
      }
      #rotate-device-overlay.visible {
        display: flex;
      }
      #rotate-device-overlay svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        animation: rotate-pulse 2.5s infinite ease-in-out;
      }
      @keyframes rotate-pulse {
        0%, 100% { transform: rotate(0deg) scale(1); }
        50% { transform: rotate(90deg) scale(1.1); }
      }
    </style>
    <!-- NUEVO: Estilos para el video de fondo -->
    <style>
      #background-video-canvas {
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1; /* Detrás de todo el contenido */
        object-fit: cover; /* Asegura que el video cubra todo el espacio sin deformarse */
      }
      /* SOLUCIÓN: Evitar que el video agrande la página y cause scroll */
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-y: auto; /* --- CORREGIDO: Permite el scroll vertical cuando es necesario --- */
      }
      /* --- NUEVO: Estilos para la sección de salas activas --- */
      .active-games-section {
        width: 100%;
        max-width: 1200px; /* Coincide con el ancho del header */
        margin: 0 auto 20px auto; /* Margen inferior para separar del carrusel */
        padding: 0 20px;
        box-sizing: border-box;
      }
      .section-title {
        font-family: 'Righteous', cursive;
        color: var(--primary-color);
        font-size: 24px;
        margin-bottom: 15px;
        text-align: left;
        padding-left: 10px;
        border-left: 4px solid var(--primary-color);
      }
      .active-games-list {
        display: flex;
        flex-direction: column; /* --- MODIFICADO: Apila las salas verticalmente --- */
        gap: 10px; /* --- MODIFICADO: Espacio entre las salas en la lista --- */
        background-color: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 12px;
        max-height: 250px; /* --- NUEVO: Altura máxima para la lista --- */
        overflow-y: auto; /* --- NUEVO: Habilita el scroll vertical si es necesario --- */
      }
      /* --- NUEVO: Estilos para la barra de desplazamiento de la lista --- */
      .active-games-list::-webkit-scrollbar {
        width: 8px;
      }
      .active-games-list::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
      }
      .active-games-list::-webkit-scrollbar-thumb {
        background: rgba(0, 242, 145, 0.5); /* Color primario con transparencia */
        border-radius: 10px;
      }
      /* --- NUEVO: Estilos para las tarjetas de salas activas --- */
      .game-card.active {
        display: flex;
        flex-direction: row; /* --- CORRECCIÓN: Forzar la dirección horizontal --- */
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: auto; /* --- NUEVO: Permitir que la altura se ajuste al contenido --- */
        flex: 0 0 auto; /* --- NUEVO: Permitir que el flex-basis se ajuste al contenido --- */
        padding: 0; /* --- ELIMINADO: El padding se manejará en un contenedor interno --- */
      }
      /* --- NUEVO: Contenedor interno para controlar el padding sin afectar la altura --- */
      .active-card-content {
        display: flex;
        width: 100%;
        align-items: center; /* --- CORRECCIÓN DEFINITIVA: Centra verticalmente y permite que la tarjeta se encoja --- */
        padding: 2px 15px; /* --- CORRECCIÓN: Padding vertical mínimo para achicar la tarjeta --- */
      }
      .card-active-players {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .player-avatar-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .player-avatar-card {
        width: 28px;  /* --- REDUCIDO AÚN MÁS: Tamaño del avatar --- */
        height: 28px; /* --- REDUCIDO AÚN MÁS: Tamaño del avatar --- */
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
      }
      /* --- NUEVO: Estilos para el contenedor de detalles de la partida (apuesta y estado) --- */
      .card-game-details {
        display: flex;
        align-items: center;
        gap: 15px; /* Espacio entre la apuesta y el estado */
        margin-left: auto; /* Empuja este contenedor a la derecha */
      }
      /* --- NUEVO: Reducir el tamaño de la fuente para achicar la tarjeta --- */
      .player-name-active,
      .vs-separator,
      .card-status-active {
        font-size: 14px; /* Tamaño de fuente más pequeño */
        color: var(--text-secondary-color);
      }
      .player-name-active {
        color: var(--text-color); /* Mantener el nombre del jugador en blanco */
        font-weight: 700;
      }

      /* --- NUEVO: Responsive para la sección de salas activas --- */
      @media (max-width: 768px) {
        .section-title {
          font-size: 20px;
          margin-bottom: 10px;
        }
        .active-games-list {
          padding: 10px;
          gap: 8px;
          max-height: 200px;
        }
        .active-card-content {
          padding: 1px 10px;
        }
        .player-avatar-card {
          width: 24px;
          height: 24px;
        }
        .card-game-details {
          gap: 10px;
        }
        .player-name-active,
        .vs-separator,
        .card-status-active {
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .section-title {
          font-size: 18px;
          margin-bottom: 8px;
        }
        .active-games-list {
          padding: 8px;
          gap: 5px;
          max-height: 150px;
        }
        .active-card-content {
          padding: 1px 5px;
        }
        .player-avatar-card {
          width: 20px;
          height: 20px;
        }
        .card-game-details {
          gap: 5px;
        }
        .player-name-active,
        .vs-separator,
        .card-status-active {
          font-size: 10px;
        }
      }

      /* --- NUEVO: Scroll para el historial de partidas ganadas --- */
      #won-games-list {
        max-height: 400px;
        overflow-y: auto;
      }

      /* --- NUEVO: Estilos para el botón de ayuda --- */
      .help-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        margin-left: 10px;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      .help-btn:hover {
        background-color: rgba(0, 242, 145, 0.1);
      }
      .help-btn svg {
        width: 24px;
        height: 24px;
      }

      /* --- NUEVO: Estilos para el modal de ayuda --- */
      #help-modal .modal-box {
        max-width: 450px;
        text-align: left;
      }
      #rules-content {
        max-height: 300px;
        overflow-y: auto;
      }
      #rules-content h4 {
        color: var(--primary-color);
        margin-top: 15px;
        margin-bottom: 5px;
      }
      #rules-content ul {
        margin: 0;
        padding-left: 20px;
      }
      #rules-content li {
        margin-bottom: 5px;
      }

      /* --- NUEVO: Responsive para el modal de ayuda --- */
      @media (max-width: 768px) {
        #help-modal .modal-box {
          max-width: 80vw;
          padding: 15px;
        }
        #rules-content {
          max-height: 250px;
          font-size: 14px;
        }
        #rules-content h4 {
          font-size: 16px;
        }
      }
      @media (max-width: 480px) {
        #help-modal .modal-box {
          max-width: 90vw;
          padding: 10px;
        }
        #rules-content {
          max-height: 200px;
          font-size: 12px;
        }
        #rules-content h4 {
          font-size: 14px;
        }
      }

      /* Notification bar styles */
      .notification-bar {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        font-size: 14px;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        animation: slideIn 1s ease-out;
      }
      @keyframes slideIn {
        0% { transform: translateX(-100%); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <!-- NUEVO: Elemento para el video de fondo -->
    <video id="background-video" autoplay muted loop playsinline style="
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        object-fit: cover;
    "></video>

    <div id="root">
        <div class="app-container">
            <header class="app-header">
                <div class="title-container">
                    <div class="header-pool-ball-container">
                        <div class="pool-ball ball-white"></div>
                        <div class="pool-ball ball-black"></div>
                    </div>
                    <h1 class="app-title">BlackBall</h1>
                    <button id="help-btn" class="help-btn" title="¿Cómo jugar?">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-6h2v6zm0-8h-2V7h2v4z"/>
                        </svg>
                    </button>
                </div>
                <div class="header-right-controls">
                    <button id="mute-music-btn" class="menu-toggle-btn" title="Silenciar Música">
                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 8.83v6.34L17.17 12 14 8.83zM12 4L7.17 9H4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3.17L12 20V4zm-2 1.17L5.83 10H4v4h1.83L10 18.83V5.17z"/></svg>
                        <svg id="unmute-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4L7.17 9H4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3.17L12 20V4zm-2 1.17L5.83 10H4v4h1.83L10 18.83V5.17zM18.5 12l1.5-1.5-1.5-1.5-1.5 1.5-1.5-1.5-1.5 1.5 1.5 1.5-1.5 1.5 1.5 1.5 1.5-1.5 1.5 1.5 1.5-1.5z"/></svg>
                    </button>
                    <div class="friends-icon-container">
                        <button id="friends-btn" class="menu-toggle-btn friends-on-glow" title="Amigos"><img src="../imajenes/amigos.png" alt="Amigos"></button>
                        <!-- NUEVO: Insignia para el contador de solicitudes de amistad -->
                        <span id="friend-request-badge" class="notification-badge"></span>
                    </div>
                    <div class="chat-icon-container">
                        <button id="friend-chat-btn" class="menu-toggle-btn" title="Chat con Amigos">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM7 9h10v2H7V9zm0 4h7v2H7v-2z"/>
                            </svg>
                        </button>
                        <!-- Insignia para mensajes no leídos -->
                        <span id="chat-badge" class="notification-badge"></span>
                    </div>

                    <div class="user-profile">
                        <div class="profile-picture-container">
                            <!-- SOLUCIÓN: Añadir un elemento <img> para la foto de perfil, inicialmente oculto -->
                            <img id="profile-picture-img" src="" alt="Foto de perfil" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                            <!-- El SVG se mostrará si no hay imagen seleccionada -->
                            <svg id="profile-picture-svg" class="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                            </svg>
                        </div>
                        <div class="user-info">
                            <span id="user-display-name">Cargando...</span>
                            <div class="user-balance">
                                <span>$0,00</span>
                            </div>
                        </div>
                        <div class="menu-container">
                            <button id="menu-toggle-btn" class="menu-toggle-btn" title="Opciones de usuario">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div id="user-menu" class="user-menu">
                                <button id="configure-ui-btn" class="menu-item" style="display: none;">Administrador</button>
                                <button id="menu-logout-btn" class="menu-item logout-item">Cerrar Sesión</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <main class="main-content">

                <!-- Barra negra semi-transparente -->
                <div id="notification-bar" class="notification-bar"></div>

                <!-- Notificación de ganancia -->
                <div id="game-win-notification" class="game-win-notification" style="display: none;"></div>

                <!-- Salas -->
                <div id="global-games-section" class="active-games-section">
                    <h2 class="section-title">Salas</h2>
                    <div id="global-games-list" class="active-games-list">
                        <!-- Lista de salas -->
                    </div>
                </div>

                <!-- Carrusel de juegos -->
                <div class="game-carousel-container">
                    <div class="game-carousel" id="main-game-carousel"></div>
                </div>

                <!-- --- MOVIDO: El modal de chat ahora está fuera de las listas y centrado --- -->
                <div id="waiting-screen" class="chat-modal-overlay">
                    <div class="chat-modal">
                        <div class="chat-header">
                            <div id="chat-action-buttons" class="chat-action-buttons">
                                <button id="start-game-btn" class="play-button" style="display: none;">Iniciar</button>
                                <button id="cancel-wait-btn" class="cancel-button" title="Cancelar">X</button>
                                <button id="abandon-game-btn" class="abandon-button" style="display: none;">Abandonar</button>
                            </div>
                            <div class="player-info">
                                <span id="player1-chat-name" class="player-name">Tu Usuario</span>
                                <img id="player1-chat-avatar" class="chat-avatar" src="" alt="Avatar Jugador 1" style="display: none;">
                                <span class="vs-text">vs</span>
                                <img id="player2-chat-avatar" class="chat-avatar" src="" alt="Avatar Jugador 2" style="display: none;">
                                <span id="player2-chat-name" class="player-name opponent">Oponente</span>
                                <button id="kick-opponent-btn" class="kick-button" title="Expulsar Oponente" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="chat-messages">
                        </div>
                        <div class="chat-controls-container">
                            <div class="chat-left-button-area">
                                <button id="left-chat-button" class="menu-toggle-btn" title="Amigos"><img src="../imajenes/amigos.png" alt="Amigos"></button>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="chat-message-input" placeholder="Escribe un mensaje...">
                                <button id="send-chat-message-btn">Enviar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="game-carousel-container">
                    <!-- NUEVO: Modal de Fin de Partida -->
                    <div id="always-visible-modal" class="modal-overlay">
                        <div class="modal-box">
                            <h3>¡Partida Terminada!</h3>
                            <div class="game-result-players">
                                <div class="player-result winner">
                                    <span class="result-label">Ganador</span>
                                    <img id="winner-avatar" src="" alt="Avatar Ganador" class="result-avatar">
                                    <span id="winner-username" class="result-username"></span>
                    <span id="winner-amount" class="result-amount"></span> <!-- NUEVO -->
                                </div>
                                <div class="player-result loser">
                                    <span class="result-label">Perdedor</span>
                                    <img id="loser-avatar" src="" alt="Avatar Perdedor" class="result-avatar">
                                    <span id="loser-username" class="result-username"></span>
                    <span id="loser-amount" class="result-amount"></span> <!-- NUEVO -->
                                </div>
                                                         </div>

                        </div>
                    </div>
                    <div class="game-carousel" id="secondary-game-carousel"></div>
                </div>

            </main>
        </div>
    </div>

    <!-- NUEVO: Pantalla para pedir al usuario que rote el dispositivo -->
    <div id="rotate-device-overlay">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M16.83 14.56c.39-.39.39-1.02 0-1.41L14.71 11H19c.55 0 1-.45 1-1s-.45-1-1-1h-4.29l2.12-2.12c.39-.39.39-1.02 0-1.41a.996.996 0 0 0-1.41 0l-3.59 3.59c-.39.39-.39 1.02 0 1.41l3.59 3.59c.39.39 1.02.39 1.41 0zM5 3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h7.5c.55 0 1-.45 1-1s-.45-1-1-1H5V5h7.5c.55 0 1-.45 1-1s-.45-1-1-1H5z"/>
      </svg>
      <h2>Gira tu dispositivo</h2>
      <p>Para una mejor experiencia, por favor, usa el modo horizontal.</p>
    </div>

    <!-- NUEVO: Contenedor para el juego -->
    <div id="game-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background-color: black;">
        <iframe id="game-iframe" src="" frameborder="0" style="width: 100%; height: 100%;"></iframe>
    </div>
    <!-- --- NUEVO: Modal de Amigos --- -->
    <div id="friends-modal" class="modal-overlay">
        <div class="modal-box">
            <!-- --- MOVIDO: Contenedor para mostrar y copiar el ID de usuario --- -->
            <div id="user-id-container">
                <div>
                    <span style="font-size: 12px; color: var(--text-secondary-color);">Tu ID:</span><br>
                    <span id="user-friend-id">Cargando...</span>
                </div>
                <button id="copy-friend-id-btn" class="menu-toggle-btn" title="Copiar ID"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
            </div>
            <!-- --- NUEVO: Buscador de amigos --- -->
            <div id="add-friend-container">
                <div id="friend-search-view">
                    <div class="input-group">
                        <input type="text" id="friend-search-input" class="form-input" placeholder="Buscar por ID o Username...">
                        <button id="friend-search-btn" class="menu-toggle-btn" title="Buscar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></button>
                    </div>
                    <p id="friend-search-error"></p>
                </div>
                <div id="friend-result-view">
                    <div id="found-user-info">
                        <div id="found-user-avatar">
                            <img id="found-user-avatar-img" src="" alt="Avatar" style="display: none;">
                            <svg id="found-user-avatar-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        </div>
                        <span id="found-username"></span>
                    </div>
                    <div class="found-user-actions">
                        <button id="add-friend-btn" class="play-button">Añadir</button>
                        <button id="cancel-add-friend-btn" class="cancel-button">Cancelar</button>
                    </div>
                </div>
            </div>
            <!-- --- MODIFICADO: Contenedor para ambas listas --- -->
            <div id="friends-content-wrapper">
                <div id="friends-list-container" class="friend-list-panel">
                    <h4>Mis Amigos</h4>
                    <!-- La lista de amigos se cargará aquí -->
                   
                </div>
                <div id="friend-requests-container" class="friend-list-panel">
                    <h4>Solicitudes</h4>
                    <!-- Las solicitudes de amistad se cargarán aquí -->
                    
                </div>
                <!-- --- NUEVO: Contenedor separado para invitaciones a partidas --- -->
                <div id="game-invites-container" class="friend-list-panel">
                    <h4>Invitaciones a Partida</h4>
                    <!-- Las invitaciones a partidas se cargarán aquí -->
                </div>
            </div>
            <button id="close-friends-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px; display: none;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para chatear con amigos --- -->
    <div id="friend-chat-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Chat con Amigos</h3>
            <div id="friend-chat-list">
                <!-- Lista de amigos para chatear -->
            </div>
            <div id="friend-chat-area" style="display: none;">
                <div id="friend-chat-messages" class="chat-messages"></div>
                <input type="text" id="friend-chat-input" placeholder="Escribe un mensaje...">
                <button id="send-friend-chat-btn">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
    </svg>
</button>
            </div>
            <button id="close-friend-chat-modal-btn" class="cancel-button">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para Invitar Amigos a la Sala --- -->
    <div id="invite-friends-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Invitar Amigos a la Sala</h3>
            <div id="invite-friends-list-container" class="friend-list-panel">
                <h4>Mis Amigos</h4>
                <!-- La lista de amigos para invitar se cargará aquí -->
            </div>
            <button id="close-invite-friends-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Pantalla de carga al encontrar partida --- -->
    <div id="match-loading-overlay" class="modal-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <h3 id="match-loading-text">Cargando...</h3>
        </div>
    </div>
        <!-- --- NUEVO: Modal para mensajes de mantenimiento del servidor --- -->
    <div id="maintenance-modal" class="error-modal-overlay">
        <div class="error-modal-box">
            <h3>Servidores en Mantenimiento</h3>
            <p>Actualmente, nuestros servidores están experimentando una alta demanda o están en mantenimiento. Por favor, inténtalo de nuevo más tarde.</p>
            <p>Se espera que los servicios se restablezcan en las próximas horas.</p>
            <div class="error-modal-actions">
                <button id="close-maintenance-modal-btn" class="close-button">Entendido</button>
            </div>
        </div>
    </div>
    <!-- --- NUEVO: Modal Principal de Avatar --- -->
    <div id="main-avatar-modal" class="modal-overlay">
        <div class="modal-box profile-modal-box">
            <h3>Mi Perfil</h3>
            <div id="main-current-avatar-display" class="current-avatar-display">
                    <img id="main-current-avatar-img" src="" alt="Tu Avatar Actual" style="max-width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                <span>Haz clic para cambiar</span>
            </div>
            <button id="open-won-games-modal-btn" class="play-button">Partidas Ganadas</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para seleccionar foto de perfil (ahora solo la grilla) --- -->
    <div id="avatar-selection-modal" class="modal-overlay">
        <div class="modal-box profile-modal-box">
            <h3>Elige tu Avatar</h3>
            <div id="avatar-grid" class="avatar-grid">
                <!-- Las imágenes se cargarán aquí con JS -->
            </div>
            <!-- Reutilizamos el estilo del botón de cancelar espera -->
            <button id="close-avatar-selection-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para partidas ganadas --- -->
    <div id="won-games-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Partidas Ganadas</h3>
            <div id="won-games-list">
                <!-- Lista de partidas ganadas -->
            </div>
            <button id="close-won-games-modal-btn" class="cancel-button">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para realizar apuesta --- -->
    <div id="bet-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Realizar Apuesta</h3>
            <p>Ingresa el monto que deseas apostar. Mínimo: $1,000.</p>
            <div class="input-group" style="margin: 15px 0;">
                  <input type="number" id="bet-amount-input" class="form-input" placeholder="Monto de la apuesta" min="1000" step="100">
            </div>
            <div class="input-group" style="margin: 15px 0; display: flex; align-items: center; justify-content: center;">
                <input type="checkbox" id="private-room-checkbox" style="margin-right: 10px;">
                <label for="private-room-checkbox" style="cursor: pointer;">Sala Privada</label>
            </div>
            <p id="bet-error-message" style="color: #e74c3c; min-height: 1em;"></p>
            <div class="modal-buttons">
                <button id="cancel-bet-btn" class="cancel-button" style="background-color: #555; border-color: #777;">Cancelar</button>
                <button id="confirm-bet-btn" class="play-button" style="font-size: 18px; padding: 15px 30px;">Apostar y Crear</button>
            </div>
        </div>
    </div>

    <!-- --- NUEVO: Modal de ayuda con reglas del juego --- -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>¿Cómo Jugar BlackBall?</h3>
            <div id="rules-content">
                <p><strong>Objetivo:</strong> Ser el primero en meter la bola negra (8) en la tronera después de haber metido todas tus bolas asignadas.</p>
                <h4>Reglas Básicas:</h4>
                <ul>
                    <li>El juego comienza con 15 bolas de colores y 1 bola blanca (taco).</li>
                    <li>En el primer tiro, se asignan grupos: sólidas (1-7) o rayadas (9-15).</li>
                    <li>Debes meter tus bolas asignadas antes de la negra.</li>
                    <li>Si metes la bola blanca o cometes una falta, pierdes el turno.</li>
                    <li>Faltas incluyen: no golpear ninguna bola, golpear fuera de turno, etc.</li>
                </ul>
                <h4>Efectos:</h4>
                <ul>
                    <li><strong>Lateral:</strong> Gira el control para efecto lateral (izquierda/derecha).</li>
                    <li><strong>Vertical:</strong> Arrastra arriba/abajo para corrido (adelante) o retroceso (atrás).</li>
                </ul>
                <h4>Victoria:</h4>
                <ul>
                    <li>Gana quien meta la bola 8 legalmente después de sus bolas.</li>
                    <li>Si metes la 8 antes o por falta, pierdes.</li>
                </ul>
                <h4>Notas de Juego:</h4>
                <ul>
                    <li>Para asegurar la sincronización perfecta y prevenir trampas, utilizamos herramientas avanzadas que pueden causar un pequeño retraso en los golpes de las bolas. Esto garantiza que ambos jugadores vean la misma simulación en tiempo real.</li>
                    <li>A diferencia de las partidas profesionales de billar, no hay "bola en mano" después de faltas. En este modo de apuestas, el turno pasa directamente al oponente para mantener un ritmo rápido y justo.</li>
                </ul>
                <h4>House Rake:</h4>
                <p>Aplicamos un house rake del 5% en las ganancias para cubrir los costos operativos, incluyendo servidores, desarrollo continuo, mantenimiento de la plataforma y mejoras de la experiencia de usuario. Esto nos permite ofrecer un servicio gratuito y de alta calidad.</p>
                <p>¡Diviértete y juega limpio!</p>
            </div>
        </div>
    </div>
        <!-- --- NUEVO: Modal para copiar errores de consola --- -->
    <div id="error-console-modal" class="error-modal-overlay">
        <div class="error-modal-box">
            <h3>Errores de Consola</h3>
            <textarea id="error-console-textarea" readonly></textarea>
            <div class="error-modal-actions">
                <button id="copy-errors-btn" class="copy-button">Copiar Errores</button>
                <button id="close-error-modal-btn" class="close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- CORRECCIÓN: Cargar main.js, que es el punto de entrada principal de la aplicación -->
    <script type="module" src="./home-ecensiales/main.js" defer></script>
    <!-- NUEVO: Script para el video de fondo aleatorio en canvas -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const videoElement = document.getElementById('background-video');

      const videos = [
        './video/video2.mp4',
        './video/video3.mp4'
      ];

      const randomVideo = videos[Math.floor(Math.random() * videos.length)];
      videoElement.src = randomVideo;

      const isIPhone = /iPhone/i.test(navigator.userAgent);

      if (isIPhone) {
          videoElement.style.display = 'none'; // Hide video
          const backgroundImage = document.createElement('img');
          backgroundImage.src = './video/iphone.png'; // Imagen para iPhone
          backgroundImage.style.position = 'fixed';
          backgroundImage.style.right = '0';
          backgroundImage.style.bottom = '0';
          backgroundImage.style.minWidth = '100%';
          backgroundImage.style.minHeight = '100%';
          backgroundImage.style.width = 'auto';
          backgroundImage.style.height = 'auto';
          backgroundImage.style.zIndex = '-1';
          backgroundImage.style.objectFit = 'cover';
          document.body.appendChild(backgroundImage);
          return; // Exit the script as we're using an image
      }

      const isMobile = /Android|iPad|iPod/i.test(navigator.userAgent); // isIPhone already handled

      if (isMobile) {
          // For mobile, try to play, but if it fails, use a fallback image
          videoElement.loop = false; // Play once on Android
          videoElement.onended = () => {
              videoElement.pause(); // Pause when ended
          };
          const playPromise = videoElement.play();
          if (playPromise !== undefined) {
              playPromise.catch(error => {
                  console.warn('Autoplay prevented on mobile, falling back to image:', error);
                  videoElement.style.display = 'none'; // Hide video
                  const backgroundImage = document.createElement('img');
                  backgroundImage.src = './video/iphone.png'; // Use a generic mobile fallback image
                  backgroundImage.style.position = 'fixed';
                  backgroundImage.style.right = '0';
                  backgroundImage.style.bottom = '0';
                  backgroundImage.style.minWidth = '100%';
                  backgroundImage.style.minHeight = '100%';
                  backgroundImage.style.width = 'auto';
                  backgroundImage.style.height = 'auto';
                  backgroundImage.style.zIndex = '-1';
                  backgroundImage.style.objectFit = 'cover';
                  document.body.appendChild(backgroundImage);
              });
          }
      } else {
          // For desktop, play once and pause at the end
          videoElement.loop = false;
          videoElement.onended = () => {
              videoElement.pause(); // Pause when ended
          };
          videoElement.play().catch(error => {
              console.warn('Autoplay prevented on desktop:', error);
          });
      }
    });
  </script>
  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
  import { getFirestore, collection, query, where, orderBy, limit, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
  import { getState } from './home-ecensiales/state.js';

  const firebaseConfig = {
      apiKey: "AIzaSyARtudlNYekKYm3zDl1r4RsinP1b3GUlu4",
      authDomain: "blackball-93ed0.firebaseapp.com",
      projectId: "blackball-93ed0",
      storageBucket: "blackball-93ed0.firebasestorage.app",
      messagingSenderId: "25368743673",
      appId: "1:25368743673:web:2702ce575622ceb7341c28",
      measurementId: "G-MSX7ELVR48"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded fired in home.html');

    const alwaysVisibleModal = document.getElementById('always-visible-modal');
    const winnerAvatarImg = document.getElementById('winner-avatar');
    const winnerUsernameSpan = document.getElementById('winner-username');
    const winnerAmountSpan = document.getElementById('winner-amount');
    const loserAvatarImg = document.getElementById('loser-avatar');
    const loserUsernameSpan = document.getElementById('loser-username');
    const loserAmountSpan = document.getElementById('loser-amount');
    const notificationBar = document.getElementById('notification-bar');

    if (!alwaysVisibleModal) console.error('alwaysVisibleModal not found!');
    if (!winnerAvatarImg) console.error('winnerAvatarImg not found!');
    if (!winnerUsernameSpan) console.error('winnerUsernameSpan not found!');
    if (!winnerAmountSpan) console.error('winnerAmountSpan not found!');
    if (!loserAvatarImg) console.error('loserAvatarImg not found!');
    if (!loserUsernameSpan) console.error('loserUsernameSpan not found!');
    if (!loserAmountSpan) console.error('loserAmountSpan not found!');

    // Function to load game results from Firebase
    const loadGameResults = async () => {
      const { currentUser } = getState();
      if (!currentUser) return;

      const q = query(collection(db, "gameResults"), where("userUid", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
        console.log('Game results found in Firebase. Populating modal.');
        const docs = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp);
        const data = docs[0].data();

        winnerAvatarImg.src = data.winnerAvatar;
        winnerUsernameSpan.textContent = data.winnerUsername || 'Desconocido';
        winnerAmountSpan.textContent = data.winnerAmount ? `Ganó: $${data.winnerAmount}` : '';
        loserAvatarImg.src = data.loserAvatar;
        loserUsernameSpan.textContent = data.loserUsername || 'Desconocido';
        loserAmountSpan.textContent = data.loserAmount ? `Perdió: $${data.loserAmount}` : '';

        // Mostrar mensaje de victoria en la barra de notificaciones si el usuario ganó
        if (data.winnerUsername === currentUserProfile.username) {
            notificationBar.innerHTML = `¡Felicidades! Ganaste $${data.winnerAmount}`;
        }

        alwaysVisibleModal.style.display = 'flex';
        alwaysVisibleModal.style.opacity = '1';
        alwaysVisibleModal.style.visibility = 'visible';
        alwaysVisibleModal.style.zIndex = '10000';
        alwaysVisibleModal.dataset.docId = docs[0].id;
      } else {
        alwaysVisibleModal.style.display = 'none';
        console.log('No game results found in Firebase. Modal is hidden.');
      }
    };

    // Function to load global notifications
    const loadNotifications = async () => {
      const q = query(collection(db, "globalNotifications"));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
        const docs = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp).slice(0, 5);
        const messages = docs.map(doc => doc.data().message);
        const globalMessages = messages.join(' | ');
        // Append to existing content (e.g., win message)
        const existingContent = notificationBar.innerHTML.trim();
        notificationBar.innerHTML = existingContent ? `${existingContent} | ${globalMessages}` : globalMessages;

        // Delete notifications older than 1.5 minutes
        const cutoff = Date.now() - 90000;
        docs.forEach(async (doc) => {
          if (doc.data().timestamp < cutoff) {
            await deleteDoc(doc.ref);
          }
        });
      } else {
        // If no global messages, keep existing content (e.g., win message)
        if (!notificationBar.innerHTML.trim()) {
          notificationBar.textContent = '';
        }
      }
    };

    // Function to clear game results from Firebase
    const clearGameResults = async () => {
      const docId = alwaysVisibleModal.dataset.docId;
      if (docId) {
        await deleteDoc(doc(db, "gameResults", docId));
        console.log('Game results deleted from Firebase.');
      }
    };

    // Load results on DOMContentLoaded
    loadGameResults();
    loadNotifications();

    // Load results when window gains focus (e.g., when returning from game)
    window.addEventListener('focus', () => { loadGameResults(); loadNotifications(); });

    // Load results periodically in a loop
    setInterval(() => { loadGameResults(); loadNotifications(); }, 2000);

    // Add event listener to close modal when clicking outside the modal-box
    alwaysVisibleModal.addEventListener('click', async (event) => {
      if (event.target === alwaysVisibleModal) {
        alwaysVisibleModal.style.display = 'none'; // Explicitly hide it
        await clearGameResults(); // Clear data from Firebase
        console.log('Game Over Modal closed by clicking outside.');
      }
    });
  });
  </script>
</body>
  <script>
    // --- SOLUCIÓN: Evitar el reajuste de altura en móviles ---
    // Esta función establece la altura del contenedor principal a la altura
    // de la ventana interna en el momento de la carga. Esto previene que el
    // layout "salte" cuando la barra de direcciones del navegador móvil
    // aparece o desaparece.
    function setAppHeight() {
      const appContainer = document.querySelector('.app-container');
      if (!appContainer) return;

      const setHeight = () => {
        const vh = window.innerHeight;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        appContainer.style.height = `${window.innerHeight}px`;
      };

      setHeight();

      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(setHeight, 100);
      });
    }
    window.addEventListener('load', setAppHeight);

    // --- NUEVO: Ocultar las secciones de salas cuando el chat está abierto ---
    const chatModal = document.getElementById('waiting-screen');
    const gameCarousel = document.getElementById('main-game-carousel');
    const globalGamesSection = document.getElementById('global-games-section');

    if (chatModal && gameCarousel && globalGamesSection) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const hide = chatModal.classList.contains('visible');
            gameCarousel.style.display = hide ? 'none' : '';
            globalGamesSection.style.display = hide ? 'none' : '';
          }
        });
      });
      observer.observe(chatModal, { attributes: true, attributeFilter: ['class'] });
    }

    // --- NUEVO: Lógica para el modal de ayuda ---
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');

    if (helpBtn && helpModal) {
        helpBtn.addEventListener('click', () => {
            helpModal.classList.add('visible');
        });
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.remove('visible');
            }
        });
    }

    // --- MODIFICADO: Lógica de orientación para Android y iOS ---
    async function lockOrientation() {
      const rotateOverlay = document.getElementById('rotate-device-overlay');
      const rootElement = document.getElementById('root');

      // Función para comprobar y mostrar/ocultar el overlay
      const checkOrientation = () => {
        // Usamos matchMedia que es el método más fiable
        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        if (isPortrait) {
          rotateOverlay.classList.add('visible');
          rootElement.style.display = 'none';
        } else {
          rotateOverlay.classList.remove('visible');
          rootElement.style.display = 'block';
        }
      };

      // Intenta bloquear la pantalla (funcionará en Android)
      try {
        if (screen.orientation && screen.orientation.lock) {
          await screen.orientation.lock('landscape').catch(() => {}); // Empty catch as requested
          console.log('Orientación bloqueada a horizontal.');
        }
      } catch (error) {
        // Silencio, esperado en iOS y algunos navegadores.
      }

      // Ejecuta la comprobación al cargar y cada vez que cambie la orientación
      checkOrientation();
      window.addEventListener('orientationchange', checkOrientation);
      window.addEventListener('resize', checkOrientation); // Fallback para algunos dispositivos
    }
    window.addEventListener('load', lockOrientation);
  </script>

</html>
