<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlackBall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- SOLUCIÓN: Evita el error 404 de favicon.ico en la consola -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- NUEVO: SDK de PocketBase -->
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="./home-ecensiales/style.css">
    <!-- NUEVO: Estilos para la pantalla de rotación en iOS -->
    <style>
      #rotate-device-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color, #1a1a1a);
        z-index: 10000;
        display: none; /* Oculto por defecto */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: var(--text-color, #ffffff);
        font-family: 'Roboto', sans-serif;
        text-align: center;
      }
      #rotate-device-overlay.visible {
        display: flex;
      }
      #rotate-device-overlay svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        animation: rotate-pulse 2.5s infinite ease-in-out;
      }
      @keyframes rotate-pulse {
        0%, 100% { transform: rotate(0deg) scale(1); }
        50% { transform: rotate(90deg) scale(1.1); }
      }
    </style>
  </head>
  <body>
    <!-- MODIFICADO: Quitado 'loop' para que el video se reproduzca una vez y se pause al final -->
    <video autoplay muted playsinline id="background-video" preload="auto"></video>

    <div id="root">
        <div class="app-container">
            <header class="app-header">
                <div class="title-container">
                    <div class="header-pool-ball-container">
                        <div class="pool-ball ball-white"></div>
                        <div class="pool-ball ball-black"></div>
                    </div>
                    <h1 class="app-title">BlackBall</h1>

                </div>
                <div class="header-right-controls">
                    <button id="mute-music-btn" class="menu-toggle-btn" title="Silenciar Música">
                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 8.83v6.34L17.17 12 14 8.83zM12 4L7.17 9H4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3.17L12 20V4zm-2 1.17L5.83 10H4v4h1.83L10 18.83V5.17z"/></svg>
                        <svg id="unmute-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4L7.17 9H4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3.17L12 20V4zm-2 1.17L5.83 10H4v4h1.83L10 18.83V5.17zM18.5 12l1.5-1.5-1.5-1.5-1.5 1.5-1.5-1.5-1.5 1.5 1.5 1.5-1.5 1.5 1.5 1.5 1.5-1.5 1.5 1.5 1.5-1.5z"/></svg>
                    </button>
                    <div class="friends-icon-container">
                        <button id="friends-btn" class="menu-toggle-btn friends-on-glow" title="Amigos"><img src="../imajenes/amigos.png" alt="Amigos"></button>
                        <!-- NUEVO: Insignia para el contador de solicitudes de amistad -->
                        <span id="friend-request-badge" class="notification-badge"></span>
                    </div>

                    <div class="user-profile">
                        <div class="profile-picture-container">
                            <!-- SOLUCIÓN: Añadir un elemento <img> para la foto de perfil, inicialmente oculto -->
                            <img id="profile-picture-img" src="" alt="Foto de perfil" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                            <!-- El SVG se mostrará si no hay imagen seleccionada -->
                            <svg id="profile-picture-svg" class="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                            </svg>
                        </div>
                        <div class="user-info">
                            <span id="user-display-name">Cargando...</span>
                            <div class="user-balance">
                                <span>$0,00</span>
                            </div>
                        </div>
                        <div class="menu-container">
                            <button id="menu-toggle-btn" class="menu-toggle-btn" title="Opciones de usuario">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div id="user-menu" class="user-menu">
                                <button id="configure-ui-btn" class="menu-item" style="display: none;">Administrador</button>
                                <button id="menu-logout-btn" class="menu-item logout-item">Cerrar Sesión</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <main class="main-content">
                <div class="game-carousel-container">
                    <div id="waiting-screen" class="chat-modal">
                        <div class="chat-header">
                            <div id="chat-action-buttons" class="chat-action-buttons">
                                <button id="start-game-btn" class="play-button" style="display: none;">Iniciar</button>
                                <button id="cancel-wait-btn" class="cancel-button" title="Cancelar">X</button>
                            </div>
                            <button id="minimize-chat-btn" class="minimize-chat-btn" title="Minimizar Chat">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                            </button>
                            <div class="player-info">
                                <span id="player1-chat-name" class="player-name">Tu Usuario</span>
                                <img id="player1-chat-avatar" class="chat-avatar" src="" alt="Avatar Jugador 1" style="display: none;">
                                <span class="vs-text">vs</span>
                                <img id="player2-chat-avatar" class="chat-avatar" src="" alt="Avatar Jugador 2" style="display: none;">
                                <span id="player2-chat-name" class="player-name opponent">Oponente</span>
                                <button id="kick-opponent-btn" class="kick-button" title="Expulsar Oponente" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="chat-messages">
                        </div>
                        <div class="chat-controls-container">
                            <div class="chat-left-button-area">
                                <button id="left-chat-button" class="menu-toggle-btn" title="Amigos"><img src="../imajenes/amigos.png" alt="Amigos"></button>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="chat-message-input" placeholder="Escribe un mensaje...">
                                <button id="send-chat-message-btn">Enviar</button>
                            </div>
                        </div>
                    </div>
                    <div class="game-carousel" id="game-carousel"></div>
                </div>

            </main>
        </div>
    </div>

    <!-- NUEVO: Pantalla para pedir al usuario que rote el dispositivo -->
    <div id="rotate-device-overlay">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M16.83 14.56c.39-.39.39-1.02 0-1.41L14.71 11H19c.55 0 1-.45 1-1s-.45-1-1-1h-4.29l2.12-2.12c.39-.39.39-1.02 0-1.41a.996.996 0 0 0-1.41 0l-3.59 3.59c-.39.39-.39 1.02 0 1.41l3.59 3.59c.39.39 1.02.39 1.41 0zM5 3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h7.5c.55 0 1-.45 1-1s-.45-1-1-1H5V5h7.5c.55 0 1-.45 1-1s-.45-1-1-1H5z"/>
      </svg>
      <h2>Gira tu dispositivo</h2>
      <p>Para una mejor experiencia, por favor, usa el modo horizontal.</p>
    </div>

    <!-- NUEVO: Contenedor para el juego -->
    <div id="game-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background-color: black;">
        <iframe id="game-iframe" src="" frameborder="0" style="width: 100%; height: 100%;"></iframe>
    </div>
    <!-- --- NUEVO: Modal de Amigos --- -->
    <div id="friends-modal" class="modal-overlay">
        <div class="modal-box">
            <!-- --- MOVIDO: Contenedor para mostrar y copiar el ID de usuario --- -->
            <div id="user-id-container">
                <div>
                    <span style="font-size: 12px; color: var(--text-secondary-color);">Tu ID:</span><br>
                    <span id="user-friend-id">Cargando...</span>
                </div>
                <button id="copy-friend-id-btn" class="menu-toggle-btn" title="Copiar ID"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
            </div>
            <!-- --- NUEVO: Buscador de amigos --- -->
            <div id="add-friend-container">
                <div id="friend-search-view">
                    <div class="input-group">
                        <input type="text" id="friend-search-input" class="form-input" placeholder="Buscar por ID o Username...">
                        <button id="friend-search-btn" class="menu-toggle-btn" title="Buscar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></button>
                    </div>
                    <p id="friend-search-error"></p>
                </div>
                <div id="friend-result-view">
                    <div id="found-user-info">
                        <div id="found-user-avatar">
                            <img id="found-user-avatar-img" src="" alt="Avatar" style="display: none;">
                            <svg id="found-user-avatar-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        </div>
                        <span id="found-username"></span>
                    </div>
                    <div class="found-user-actions">
                        <button id="add-friend-btn" class="play-button">Añadir</button>
                        <button id="cancel-add-friend-btn" class="cancel-button">Cancelar</button>
                    </div>
                </div>
            </div>
            <!-- --- MODIFICADO: Contenedor para ambas listas --- -->
            <div id="friends-content-wrapper">
                <div id="friends-list-container" class="friend-list-panel">
                    <h4>Mis Amigos</h4>
                    <!-- La lista de amigos se cargará aquí -->
                   
                </div>
                <div id="friend-requests-container" class="friend-list-panel">
                    <h4>Solicitudes</h4>
                    <!-- Las solicitudes de amistad se cargarán aquí -->
                    
                </div>
                <!-- --- NUEVO: Contenedor separado para invitaciones a partidas --- -->
                <div id="game-invites-container" class="friend-list-panel">
                    <h4>Invitaciones a Partida</h4>
                    <!-- Las invitaciones a partidas se cargarán aquí -->
                </div>
            </div>
            <button id="close-friends-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px; display: none;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para Invitar Amigos a la Sala --- -->
    <div id="invite-friends-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Invitar Amigos a la Sala</h3>
            <div id="invite-friends-list-container" class="friend-list-panel">
                <h4>Mis Amigos</h4>
                <!-- La lista de amigos para invitar se cargará aquí -->
            </div>
            <button id="close-invite-friends-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Pantalla de carga al encontrar partida --- -->
    <div id="match-loading-overlay" class="modal-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <h3 id="match-loading-text">Cargando...</h3>
        </div>
    </div>
        <!-- --- NUEVO: Modal para mensajes de mantenimiento del servidor --- -->
    <div id="maintenance-modal" class="error-modal-overlay">
        <div class="error-modal-box">
            <h3>Servidores en Mantenimiento</h3>
            <p>Actualmente, nuestros servidores están experimentando una alta demanda o están en mantenimiento. Por favor, inténtalo de nuevo más tarde.</p>
            <p>Se espera que los servicios se restablezcan en las próximas horas.</p>
            <div class="error-modal-actions">
                <button id="close-maintenance-modal-btn" class="close-button">Entendido</button>
            </div>
        </div>
    </div>
    <!-- --- NUEVO: Modal para seleccionar foto de perfil --- -->
    <div id="profile-picture-modal" class="modal-overlay">
        <div class="modal-box profile-modal-box">
            <h3>Elige tu Avatar</h3>
            <div id="avatar-grid" class="avatar-grid">
                <!-- Las imágenes se cargarán aquí con JS -->
            </div>
            <!-- Reutilizamos el estilo del botón de cancelar espera -->
            <button id="close-avatar-modal-btn" class="cancel-button" style="align-self: center; margin-top: 20px;">Cerrar</button>
        </div>
    </div>
    <!-- --- NUEVO: Modal para realizar apuesta --- -->
    <div id="bet-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Realizar Apuesta</h3>
            <p>Ingresa el monto que deseas apostar. Mínimo: $1,000.</p>
            <div class="input-group" style="margin: 15px 0;">
                 <input type="number" id="bet-amount-input" class="form-input" placeholder="Monto de la apuesta" min="1000" step="100">
            </div>
            <div class="input-group" style="margin: 15px 0; display: flex; align-items: center; justify-content: center;">
                <input type="checkbox" id="private-room-checkbox" style="margin-right: 10px;">
                <label for="private-room-checkbox" style="cursor: pointer;">Sala Privada</label>
            </div>
            <p id="bet-error-message" style="color: #e74c3c; min-height: 1em;"></p>
            <div class="modal-buttons">
                <button id="cancel-bet-btn" class="cancel-button" style="background-color: #555; border-color: #777;">Cancelar</button>
                <button id="confirm-bet-btn" class="play-button" style="font-size: 18px; padding: 15px 30px;">Apostar y Crear</button>
            </div>
        </div>
    </div>
        <!-- --- NUEVO: Modal para copiar errores de consola --- -->
    <div id="error-console-modal" class="error-modal-overlay">
        <div class="error-modal-box">
            <h3>Errores de Consola</h3>
            <textarea id="error-console-textarea" readonly></textarea>
            <div class="error-modal-actions">
                <button id="copy-errors-btn" class="copy-button">Copiar Errores</button>
                <button id="close-error-modal-btn" class="close-button">Cerrar</button>
            </div>
        </div>
    <!-- CORRECCIÓN: Cargar main.js, que es el punto de entrada principal de la aplicación -->
    <script type="module" src="./home-ecensiales/main.js"></script>
  </body>
  <!-- MODIFICADO: Script para el video de fondo aleatorio con control de volumen -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const backgroundVideo = document.getElementById('background-video');
        
        // --- CORRECCIÓN: Rutas relativas correctas para GitHub Pages ---
        const videos = [
            './video/video1.mp4',
            './video/video2.mp4',
            './video/video3.mp4'
        ];
        const randomVideo = videos[Math.floor(Math.random() * videos.length)];

        backgroundVideo.src = randomVideo;

        // Cuando el video esté listo para reproducirse, lo hacemos visible.
        backgroundVideo.addEventListener('canplay', () => {
            backgroundVideo.play().catch(error => {
                console.log("La reproducción automática del video silenciado fue bloqueada. Se iniciará con la interacción del usuario.");
            });
            // Hacemos que el video aparezca suavemente (aún silenciado).
            backgroundVideo.classList.add('visible');
        });
    });
  </script>
  <!-- NUEVO: Script para manejar el autoplay de la música -->
  <script>
    function handleFirstInteraction() {
      // Dispara un evento personalizado que el audioManager puede escuchar
      window.dispatchEvent(new CustomEvent('userInteracted'));

      // --- MODIFICADO: Activar sonido y opacidad completa del video en la primera interacción ---
      const backgroundVideo = document.getElementById('background-video');
      if (backgroundVideo && backgroundVideo.muted) {
          backgroundVideo.muted = false;
          backgroundVideo.volume = 0.04; // Establecer volumen al 4%
          backgroundVideo.classList.add('sound-on'); // Aumentar opacidad a 1
      }

      // Una vez que se ejecuta, elimina el listener para no volver a llamarlo
      // El listener ya se elimina solo porque usamos { once: true }
    }
    document.body.addEventListener('click', handleFirstInteraction, { once: true });
    document.body.addEventListener('touchstart', handleFirstInteraction, { once: true });
  </script>
  <script>
    // --- SOLUCIÓN: Evitar el reajuste de altura en móviles ---
    // Esta función establece la altura del contenedor principal a la altura
    // de la ventana interna en el momento de la carga. Esto previene que el
    // layout "salte" cuando la barra de direcciones del navegador móvil
    // aparece o desaparece.
    function setAppHeight() {
      const appContainer = document.querySelector('.app-container');
      if (!appContainer) return;
    
      const setHeight = () => {
        const vh = window.innerHeight;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        appContainer.style.height = `${window.innerHeight}px`;
      };
    
      setHeight();
    
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(setHeight, 100);
      });
    }
    window.addEventListener('load', setAppHeight);

    // --- MODIFICADO: Lógica de orientación para Android y iOS ---
    async function lockOrientation() {
      const rotateOverlay = document.getElementById('rotate-device-overlay');
      const rootElement = document.getElementById('root');

      // Función para comprobar y mostrar/ocultar el overlay
      const checkOrientation = () => {
        // Usamos matchMedia que es el método más fiable
        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        if (isPortrait) {
          rotateOverlay.classList.add('visible');
          rootElement.style.display = 'none';
        } else {
          rotateOverlay.classList.remove('visible');
          rootElement.style.display = 'block';
        }
      };

      // Intenta bloquear la pantalla (funcionará en Android)
      try {
        if (screen.orientation && typeof screen.orientation.lock === 'function') {
          await screen.orientation.lock('landscape');
          console.log('Orientación bloqueada a horizontal.');
        }
      } catch (error) {
        console.warn('No se pudo bloquear la orientación (esperado en iOS):', error.message);
      }

      // Ejecuta la comprobación al cargar y cada vez que cambie la orientación
      checkOrientation();
      window.addEventListener('orientationchange', checkOrientation);
      window.addEventListener('resize', checkOrientation); // Fallback para algunos dispositivos
    }
    window.addEventListener('load', lockOrientation);
  </script>
</html>
