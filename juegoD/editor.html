<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego 3D Top-Down</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #toggle-button, #lock-camera {
            position: absolute;
            top: 10px;
            z-index: 1000;
            padding: 10px;
            background: #fff;
            border: none;
            cursor: pointer;
        }
        #toggle-button {
            right: 10px;
        }
        #lock-camera {
            right: 120px;
        }
        #reset-camera {
            right: 240px;
        }
        #fly-mode {
            right: 350px;
        }
        #camera-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        #carousel {
            position: absolute;
            top: 50px;
            right: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }
        #carousel-items {
            height: 100px;
            overflow-x: auto;
            white-space: nowrap;
        }
        #carousel .item {
            display: inline-block;
            margin: 10px;
            text-align: center;
            cursor: pointer;
            color: white;
        }
        #scale-slider {
            position: absolute;
            top: 10px;
            right: 250px;
            width: 200px;
            z-index: 1000;
        }
        #animation-carousel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 200px;
            height: 200px;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        #animation-items {
            height: 100%;
            overflow-y: auto;
        }
        #animation-carousel .anim-item {
            margin: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            text-align: center;
        }
        #object-carousel {
            position: absolute;
            bottom: 10px;
            right: 220px;
            width: 200px;
            height: 200px;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        #object-items {
            height: 100%;
            overflow-y: auto;
        }
        #object-carousel .obj-item {
            margin: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            text-align: center;
        }
        #maps-carousel {
            position: absolute;
            top: 50px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }
        #maps-items {
            height: 100px;
            overflow-x: auto;
            white-space: nowrap;
        }
        #maps-carousel .maps-item {
            display: inline-block;
            margin: 10px;
            text-align: center;
            cursor: pointer;
            color: white;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    <input type="file" id="file-input" accept=".glb,.gltf" style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
    <button id="toggle-button">Mostrar Carrusel</button>
    <button id="lock-camera">Bloquear Cámara</button>
    <button id="reset-camera">Reiniciar Cámara</button>
    <button id="fly-mode">Modo Vuelo</button>
    <input type="range" id="scale-slider" min="0.1" max="5" step="0.1" value="1">
    <div id="camera-info">Cámara: X: 30.0, Y: 50.0, Z: 0.0, Ángulo: 0.0°</div>
    <div id="carousel">
        <div id="carousel-items">
            <div class="item" data-model="./Characters/gltf/Barbarian.glb">Barbarian</div>
            <div class="item" data-model="./Characters/gltf/Knight.glb">Knight</div>
            <div class="item" data-model="./Characters/gltf/Mage.glb">Mage</div>
            <div class="item" data-model="./Characters/gltf/Rogue.glb">Rogue</div>
            <div class="item" data-model="./Characters/gltf/Rogue_Hooded.glb">Rogue Hooded</div>
            <div class="item" data-model="./Assets/gltf/arrow.gltf">Arrow</div>
            <div class="item" data-model="./Assets/gltf/arrow_bundle.gltf">Arrow Bundle</div>
            <div class="item" data-model="./Assets/gltf/axe_1handed.gltf">Axe 1H</div>
            <div class="item" data-model="./Assets/gltf/axe_2handed.gltf">Axe 2H</div>
            <div class="item" data-model="./Assets/gltf/crossbow_1handed.gltf">Crossbow 1H</div>
            <div class="item" data-model="./Assets/gltf/crossbow_2handed.gltf">Crossbow 2H</div>
            <div class="item" data-model="./Assets/gltf/dagger.gltf">Dagger</div>
            <div class="item" data-model="./Assets/gltf/mug_empty.gltf">Mug Empty</div>
            <div class="item" data-model="./Assets/gltf/mug_full.gltf">Mug Full</div>
            <div class="item" data-model="./Assets/gltf/quiver.gltf">Quiver</div>
            <div class="item" data-model="./Assets/gltf/shield_badge.gltf">Shield Badge</div>
            <div class="item" data-model="./Assets/gltf/shield_badge_color.gltf">Shield Badge Color</div>
            <div class="item" data-model="./Assets/gltf/shield_round.gltf">Shield Round</div>
            <div class="item" data-model="./Assets/gltf/shield_round_barbarian.gltf">Shield Round Barb</div>
            <div class="item" data-model="./Assets/gltf/shield_round_color.gltf">Shield Round Color</div>
            <div class="item" data-model="./Assets/gltf/shield_spikes.gltf">Shield Spikes</div>
            <div class="item" data-model="./Assets/gltf/shield_spikes_color.gltf">Shield Spikes Color</div>
            <div class="item" data-model="./Assets/gltf/shield_square.gltf">Shield Square</div>
            <div class="item" data-model="./Assets/gltf/shield_square_color.gltf">Shield Square Color</div>
            <div class="item" data-model="./Assets/gltf/smokebomb.gltf">Smokebomb</div>
            <div class="item" data-model="./Assets/gltf/spellbook_closed.gltf">Spellbook Closed</div>
            <div class="item" data-model="./Assets/gltf/spellbook_open.gltf">Spellbook Open</div>
            <div class="item" data-model="./Assets/gltf/staff.gltf">Staff</div>
            <div class="item" data-model="./Assets/gltf/sword_1handed.gltf">Sword 1H</div>
            <div class="item" data-model="./Assets/gltf/sword_2handed.gltf">Sword 2H</div>
            <div class="item" data-model="./Assets/gltf/sword_2handed_color.gltf">Sword 2H Color</div>
            <div class="item" data-model="./Assets/gltf/wand.gltf">Wand</div>
        </div>
    </div>
    <div id="animation-carousel">
        <div id="animation-items"></div>
    </div>
    <div id="object-carousel">
        <div id="object-items"></div>
    </div>
    <div id="maps-carousel">
        <div id="maps-items">
            <div class="maps-item" data-model="./maps/floating_town-hand_painted.glb">Floating Town</div>
        </div>
    </div>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

        // Configuración de la escena
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);

        // Configuración de la cámara
        const camera = new THREE.OrthographicCamera(-15, 15, 15, -15, 1, 1000);
        camera.position.set(0, 50, 0);
        camera.lookAt(scene.position);

        // Configuración del renderizador
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luces
        const ambientLight = new THREE.AmbientLight(0x404040); // Luz ambiental suave
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 5);
        scene.add(directionalLight);

        // Suelo
        const floorGeometry = new THREE.PlaneGeometry(100, 100);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2; // Rotar para que sea horizontal
        scene.add(floor);

        // Cubo del jugador
        const cubeGeometry = new THREE.BoxGeometry(2, 2, 2);
        const cubeMaterial = new THREE.MeshStandardMaterial({ color: 0xffa500 });
        const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        cube.position.y = 1;
        scene.add(cube);

        const loader = new GLTFLoader();
        let currentModel = cube;
        let mixer;
        let animations = [];
        let objects = [];
        const clock = new THREE.Clock();
        let cameraAngle = 0;
        let cameraHeight = 50;
        let cameraDistance = 30;
        let orthoZoom = 1;
        let isDragging = false;
        let previousMouseX = 0;
        let previousMouseY = 0;
        const sensitivity = 0.005;
        const heightSensitivity = 0.1;
        let cameraControlEnabled = true;
        let targetRotationY = 0;
        let isMap = false;
        let flyMode = false;
        let cameraPitch = 0;

        updateCameraProjection();

        function loadModel(path) {
            console.log('Loading model:', path);
            loader.load(path, (gltf) => {
                console.log('Model loaded', gltf.scene);
                scene.remove(currentModel);

                // --- NUEVO: Centrar la geometría del modelo ---
                new THREE.Box3().setFromObject(gltf.scene).getCenter(gltf.scene.position).multiplyScalar(-1);

                currentModel = gltf.scene;
                if (path.includes('maps/')) {
                    isMap = true;
                    currentModel.position.set(0, 0, 0);
                    currentModel.scale.set(0.1, 0.1, 0.1);
                    scene.remove(floor);
                    // Center camera on map
                    cameraAngle = 0;
                    cameraHeight = 20;
                    cameraDistance = 10;
                    orthoZoom = 0.5;
                    updateCameraProjection();
                    if (flyMode) {
                        camera.position.set(0, 10, 10);
                        cameraPitch = 0;
                    }
                } else {
                    isMap = false;
                    currentModel.position.set(0, 1, 0);
                    currentModel.scale.set(1, 1, 1);
                }
                scene.add(currentModel);

                // --- NUEVO: Centrar la cámara en el nuevo modelo ---
                camera.lookAt(currentModel.position);


                // Handle animations
                animations = gltf.animations || [];
                if (animations.length > 0) {
                    mixer = new THREE.AnimationMixer(currentModel);
                    populateAnimationCarousel(animations);
                } else {
                    mixer = null;
                    clearAnimationCarousel();
                }

                // Handle objects
                objects = [];
                currentModel.traverse((child) => {
                    if (child.isMesh && child.name) {
                        objects.push(child);
                    }
                });
                populateObjectCarousel(objects);
            }, undefined, (error) => {
                console.error('Error loading model:', error);
                // If load fails, don't change anything
            });
        }

        function populateAnimationCarousel(anims) {
            const container = document.getElementById('animation-items');
            container.innerHTML = '';
            anims.forEach((anim, index) => {
                const div = document.createElement('div');
                div.className = 'anim-item';
                div.textContent = anim.name || `Animation ${index + 1}`;
                div.dataset.index = index;
                container.appendChild(div);
            });
        }

        function clearAnimationCarousel() {
            document.getElementById('animation-items').innerHTML = '';
        }

        function populateObjectCarousel(objs) {
            const container = document.getElementById('object-items');
            container.innerHTML = '';
            objs.forEach((obj, index) => {
                const div = document.createElement('div');
                div.className = 'obj-item';
                div.textContent = obj.name;
                div.dataset.index = index;
                div.style.background = obj.visible ? 'rgba(255,255,255,0.5)' : 'rgba(255,0,0,0.5)';
                container.appendChild(div);
            });
        }

        // Movimiento del jugador
        const speed = 0.5;
        const keys = {};

        document.addEventListener('keydown', (event) => {
            keys[event.key.toLowerCase()] = true;
        });

        document.addEventListener('keyup', (event) => {
            keys[event.key.toLowerCase()] = false;
        });

        // Mouse drag for camera control
        document.addEventListener('mousedown', (event) => {
            if (!event.target.matches('#toggle-button, #lock-camera, #scale-slider')) {
                isDragging = true;
                previousMouseX = event.clientX;
                previousMouseY = event.clientY;
                event.preventDefault();
            }
        });

        document.addEventListener('mousemove', (event) => {
            if (isDragging && cameraControlEnabled) {
                const deltaX = event.clientX - previousMouseX;
                const deltaY = event.clientY - previousMouseY;
                if (flyMode) {
                    cameraAngle += deltaX * sensitivity;
                    cameraPitch -= deltaY * heightSensitivity;
                    cameraPitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraPitch));
                } else {
                    cameraAngle += deltaX * sensitivity;
                    cameraHeight -= deltaY * heightSensitivity;
                }
                previousMouseX = event.clientX;
                previousMouseY = event.clientY;
                event.preventDefault();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        document.addEventListener('wheel', (event) => {
            if (cameraControlEnabled) {
                orthoZoom += event.deltaY * 0.001;
                orthoZoom = Math.max(0.1, Math.min(5, orthoZoom));
                updateCameraProjection();
                event.preventDefault();
            }
        });

        function moveCube() {
            if (flyMode) {
                // Move camera in fly mode
                let moveSpeed = 2; // Speed for fly
                let forward = new THREE.Vector3(0, 0, -1);
                forward.applyEuler(new THREE.Euler(cameraPitch, cameraAngle, 0));
                let right = new THREE.Vector3(1, 0, 0);
                right.applyEuler(new THREE.Euler(cameraPitch, cameraAngle, 0));
                if (keys['w']) {
                    camera.position.add(forward.clone().multiplyScalar(moveSpeed));
                }
                if (keys['s']) {
                    camera.position.add(forward.clone().multiplyScalar(-moveSpeed));
                }
                if (keys['a']) {
                    camera.position.add(right.clone().multiplyScalar(-moveSpeed));
                }
                if (keys['d']) {
                    camera.position.add(right.clone().multiplyScalar(moveSpeed));
                }
                if (keys[' ']) { // Space for up
                    camera.position.y += moveSpeed;
                }
                if (keys['shift']) { // Shift for down
                    camera.position.y -= moveSpeed;
                }
                return;
            }
            if (isMap) return; // Don't move the map
            let deltaX = 0;
            let deltaZ = 0;
            if (keys['arrowup'] || keys['w']) {
                deltaZ -= speed;
            }
            if (keys['arrowdown'] || keys['s']) {
                deltaZ += speed;
            }
            if (keys['arrowleft'] || keys['a']) {
                deltaX -= speed;
            }
            if (keys['arrowright'] || keys['d']) {
                deltaX += speed;
            }
            if (deltaX !== 0 || deltaZ !== 0) {
                targetRotationY = Math.atan2(deltaX, deltaZ);
            }
            currentModel.position.x += deltaX;
            currentModel.position.z += deltaZ;
        }

        // Bucle de animación
        function animate() {
            requestAnimationFrame(animate);
            moveCube();
            if (!isMap) {
                let delta = targetRotationY - currentModel.rotation.y;
                delta = ((delta + Math.PI) % (2 * Math.PI)) - Math.PI;
                currentModel.rotation.y += delta * 0.1;
            }
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            if (flyMode) {
                let lookAt = camera.position.clone().add(new THREE.Vector3(0, 0, -1).applyEuler(new THREE.Euler(cameraPitch, cameraAngle, 0)));
                camera.lookAt(lookAt);
            } else {
                camera.position.x = Math.cos(cameraAngle) * cameraDistance;
                camera.position.z = Math.sin(cameraAngle) * cameraDistance;
                camera.position.y = cameraHeight;
                camera.lookAt(currentModel.position);
            }
            let info = `Cámara: X: ${camera.position.x.toFixed(1)}, Y: ${camera.position.y.toFixed(1)}, Z: ${camera.position.z.toFixed(1)}, Ángulo: ${(cameraAngle * 180 / Math.PI).toFixed(1)}°`;
            if (flyMode) {
                info += `, Pitch: ${(cameraPitch * 180 / Math.PI).toFixed(1)}°`;
            }
            document.getElementById('camera-info').textContent = info;
            renderer.render(scene, camera);
        }

        // Ajustar la ventana si cambia de tamaño
        function updateCameraProjection() {
            const aspectRatio = window.innerWidth / window.innerHeight;
            camera.left = -15 * aspectRatio / orthoZoom;
            camera.right = 15 * aspectRatio / orthoZoom;
            camera.top = 15 / orthoZoom;
            camera.bottom = -15 / orthoZoom;
            camera.updateProjectionMatrix();
        }

        window.addEventListener('resize', () => {
            updateCameraProjection();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('toggle-button').addEventListener('click', () => {
            const carousel = document.getElementById('carousel');
            const animCarousel = document.getElementById('animation-carousel');
            const objCarousel = document.getElementById('object-carousel');
            const mapsCarousel = document.getElementById('maps-carousel');
            const display = carousel.style.display === 'none' ? 'block' : 'none';
            carousel.style.display = display;
            animCarousel.style.display = display;
            objCarousel.style.display = display;
            mapsCarousel.style.display = display;
        });

        document.getElementById('lock-camera').addEventListener('click', () => {
            cameraControlEnabled = !cameraControlEnabled;
            const button = document.getElementById('lock-camera');
            button.textContent = cameraControlEnabled ? 'Bloquear Cámara' : 'Desbloquear Cámara';
        });

        document.getElementById('reset-camera').addEventListener('click', () => {
            cameraAngle = 0;
            cameraHeight = 50;
            cameraDistance = 30;
            cameraPitch = 0;
            targetRotationY = 0;
            if (flyMode) {
                camera.position.set(0, 50, 0);
            }
        });

        document.getElementById('fly-mode').addEventListener('click', () => {
            flyMode = !flyMode;
            const button = document.getElementById('fly-mode');
            button.textContent = flyMode ? 'Modo Normal' : 'Modo Vuelo';
            if (flyMode) {
                // Switch to fly mode, set camera position
                camera.position.set(0, 10, 10);
                cameraAngle = 0;
                cameraPitch = 0;
            } else {
                // Switch back to normal
                cameraAngle = 0;
                cameraHeight = 50;
                cameraDistance = 30;
            }
        });


        document.querySelectorAll('.item').forEach(item => {
            item.addEventListener('click', () => {
                const modelPath = item.dataset.model;
                loadModel(modelPath);
            });
        });

        document.querySelectorAll('.maps-item').forEach(item => {
            item.addEventListener('click', () => {
                const modelPath = item.dataset.model;
                loadModel(modelPath);
            });
        });

        document.getElementById('scale-slider').addEventListener('input', (e) => {
            if (currentModel) {
                const scale = parseFloat(e.target.value);
                currentModel.scale.set(scale, scale, scale);
            }
        });

        document.getElementById('animation-items').addEventListener('click', (e) => {
            if (e.target.classList.contains('anim-item') && mixer) {
                const index = parseInt(e.target.dataset.index);
                mixer.stopAllAction();
                const action = mixer.clipAction(animations[index]);
                action.play();
            }
        });

        document.getElementById('object-items').addEventListener('click', (e) => {
            if (e.target.classList.contains('obj-item')) {
                const index = parseInt(e.target.dataset.index);
                objects[index].visible = !objects[index].visible;
                e.target.style.background = objects[index].visible ? 'rgba(255,255,255,0.5)' : 'rgba(255,0,0,0.5)';
            }
        });

        document.getElementById('file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                loadModel(url);
            }
        });

        animate();
    </script>
</body>
</html>